I = loadimageprompt();

[sx,sy] = size(I);
hx = sx/2;
hy = sy/2;

H = zeros(hx,hy);

for x=1:hx
    for y=1:hy
        H(x,y) = sum(sum( I(x*2-1:x*2, y*2-1:y*2) ))/4;
    end
end


% siehe http://en.wikipedia.org/wiki/Bicubic_interpolation
A_= [ 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
      0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0
      -3 3 0 0 -2 -1 0 0 0 0 0 0 0 0 0 0
      2 -2 0 0 1 1 0 0 0 0 0 0 0 0 0 0
      0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0
      0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0
      0 0 0 0 0 0 0 0 -3 3 0 0 -2 -1 0 0
      0 0 0 0 0 0 0 0 2 -2 0 0 1 1 0 0
      -3 0 3 0 0 0 0 0 -2 0 -1 0 0 0 0 0
      0 0 0 0 -3 0 3 0 0 0 0 0 -2 0 -1 0
      9 -9 -9 9 6 3 -6 -3 6 -6 3 -3 4 2 2 1
      -6 6 6 -6 -3 -3 3 3 -4 4 -2 2 -2 -2 -1 -1
      2 0 -2 0 0 0 0 0 1 0 1 0 0 0 0 0
      0 0 0 0 2 0 -2 0 0 0 0 0 1 0 1 0
      -6 6 6 -6 -4 -2 4 2 -3 3 -3 3 -2 -1 -2 -1
      4 -4 -4 4 2 2 -2 -2 2 -2 2 -2 1 1 1 1 ]

R = zeros(sx,sy);
for x=1:hx-2
    for y=1:hy-2
        r = H(x:x+2, y:y+2);

        f00 = r(1,1);
        f10 = r(2,1);
        f01 = r(1,2);
        f11 = r(2,2);

        f00x = r(1+1,1)-r(1,1);
        f10x = r(2+1,1)-r(2,1);
        f01x = r(1+1,2)-r(1,2);
        f11x = r(2+1,2)-r(2,2);

        f00y = r(1,1+1)-r(1,1);
        f10y = r(2,1+1)-r(2,1);
        f01y = r(1,2+1)-r(1,2);
        f11y = r(2,2+1)-r(2,2);

        f00xy = r(1+1,1+1)-r(1,1);
        f10xy = r(2+1,1+1)-r(2,1);
        f01xy = r(1+1,2+1)-r(1,2);
        f11xy = r(2+1,2+1)-r(2,2);

        z = [f00;f10;f01;f11;f00x;f10x;f01x;f11x;f00y;f10y;f01y;f11y;f00xy;f10xy;f01xy;f11xy];


        a = A_ * z;
        
        x2 = x*2;
        y2 = y*2;

        u=1/4;
        v=1/4;
        R(x2-1,y2-1) = [u^0*v^0 u^0*v^1 u^0*v^2 u^0*v^3 u^1*v^0 u^1*v^1 u^1*v^2 u^1*v^3 u^2*v^0 u^2*v^1 u^2*v^2 u^2*v^3 u^3*v^0 u^3*v^1 u^3*v^2 u^3*v^3 ] * a;
        u=1/4;
        v=3/4;
        R(x2  ,y2-1) = [u^0*v^0 u^0*v^1 u^0*v^2 u^0*v^3 u^1*v^0 u^1*v^1 u^1*v^2 u^1*v^3 u^2*v^0 u^2*v^1 u^2*v^2 u^2*v^3 u^3*v^0 u^3*v^1 u^3*v^2 u^3*v^3 ] * a;
        u=3/4;
        v=1/4;
        R(x2-1,y2  ) = [u^0*v^0 u^0*v^1 u^0*v^2 u^0*v^3 u^1*v^0 u^1*v^1 u^1*v^2 u^1*v^3 u^2*v^0 u^2*v^1 u^2*v^2 u^2*v^3 u^3*v^0 u^3*v^1 u^3*v^2 u^3*v^3 ] * a;
        u=3/4;
        v=3/4;
        R(x2  ,y2  ) = [u^0*v^0 u^0*v^1 u^0*v^2 u^0*v^3 u^1*v^0 u^1*v^1 u^1*v^2 u^1*v^3 u^2*v^0 u^2*v^1 u^2*v^2 u^2*v^3 u^3*v^0 u^3*v^1 u^3*v^2 u^3*v^3 ] * a;
    end
end

